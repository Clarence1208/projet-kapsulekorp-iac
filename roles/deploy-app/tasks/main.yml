- name: "Determine DB host for this web server"
  set_fact:
    db_host: >-
      {{
        (inventory_hostname in groups['production-web'])
          | ternary(hostvars[groups['production-db'][0]].ansible_host,
                  hostvars[groups['staging-db'][0]].ansible_host)
      }}
    db_password: >-
      {{
        (inventory_hostname in groups['production-web'])
          | ternary(db_password_prod, db_password_staging)
      }}

- name: "Ensure app directory exists"
  ansible.builtin.file:
    path: "{{ app_root }}"
    state: directory
    owner: www-data
    group: www-data
    mode: "0755"

- name: "Deploy application configuration file"
  ansible.builtin.template:
    src: templates/config.php.j2
    dest: "{{ app_root }}/config.php"
    owner: www-data
    group: www-data
    mode: "0644"
    vars:
      db_host: "{{ db_host }}"
      db_name: "{{ db_name }}"
      db_user: "{{ db_user }}"
      db_password: "{{ db_password }}"

- name: "Deploy application files"
  ansible.builtin.copy:
    src: files/index.php
    dest: "{{ app_root }}/index.php"
    owner: www-data
    group: www-data
    mode: "0644"